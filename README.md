# Genetic-Based Drug Repurposing Pipeline for Head and Neck Cancer (Nulton Cohort)

## Overview

This pipeline performs a comprehensive genetic analysis of the TCGA Head and Neck Cancer (HNSC) cohort to identify drug repurposing candidates stratified by HPV status. The workflow integrates copy number variation (CNV) data, somatic mutation (SOM) data, protein-protein interaction (PPI) networks, and DrugBank annotations to discover both **direct** (drug directly targets mutated genes) and **indirect** (drug targets genes connected via PPI to mutated genes) therapeutic candidates. 

The pipeline consists of 8 major analysis notebooks (00-07) that sequentially process genomic data, identify significantly mutated genes in HPV-positive and HPV-negative cohorts, discover drug candidates through statistical enrichment testing and literature validation, and visualize the results. Key statistical methods include hypergeometric testing for drug-gene enrichment and empirical permutation testing for significance validation. Results are validated against PubMed literature using GPU-accelerated natural language processing to confirm drug-gene interactions.

The final outputs include tables of drug repurposing candidates with DrugBank-verified actions, literature validation, mutation types, statistical significance metrics, and network visualization graphs showing drug-gene relationships for both HPV+ and HPV- patient cohorts.

---

## Project Directory Structure

```
Genetic based drug repurposing Nulton cohort/
│
├── 00 Data viewing.ipynb
├── 01 determine HPV status.ipynb
├── 02 CNV identify mutation gene.ipynb
├── 02.2 CNV key mutation identification.ipynb
├── 02.50 CNV drug repurposing candidates copy.ipynb
├── 03 SOM identify key mutation gene.ipynb
├── 03.5 SOM drug repurpose.ipynb
├── 03.75 result viewing.ipynb
├── 04 SOM and CNV results comparison.ipynb
├── 05 Final result creation.ipynb
├── 06 Graph direct results.ipynb
├── 06 Graph results.ipynb
├── 07 graph indirect results.ipynb
├── 07_sankey_diagram_builder.ipynb
├── README.md
│
├── Data/                                    # INPUT DATA (user must provide)
│   ├── gdc-client                          # GDC data transfer tool (optional)
│   │
│   ├── DGIDB/                              # DrugBank database
│   │   ├── drug_bank.xml                   # REQUIRED: DrugBank XML file (download from DrugBank)
│   │   └── Drug_bank_drug_gene_interactions.csv  # Optional processed version
│   │
│   ├── Protein-protein interaction data/   # STRING PPI database
│   │   ├── 9606.protein.links.v12.0.txt              # REQUIRED: PPI network links
│   │   ├── 9606.protein.links.full.v12.0.txt         # Optional: Full PPI data
│   │   ├── 9606.protein.links.detailed.v12.0.txt     # Optional: Detailed PPI data
│   │   ├── 9606.protein.info.v12.0.txt               # REQUIRED: Protein information
│   │   ├── 9606.protein.aliases.v12.0.txt            # REQUIRED: Protein name aliases
│   │   └── BIOGRID-ORGANISM-Homo_sapiens-4.4.246.psi25.xml  # Optional: Alternative PPI source
│   │
│   ├── Supplementary data Nulton/          # Nulton et al. supplementary data
│   │   ├── 1. HPV Genomes for alignment.csv
│   │   ├── 2. HNC HPV Types.csv            # REQUIRED: HPV+ TCGA case IDs
│   │   ├── 3. HNC HPV State Categories.csv
│   │   ├── 4. HPV-human jxn sites.csv
│   │   ├── 5. HNSC NR4A2,RAD51L1,TRPC4AP.csv
│   │   ├── TCGA CASE ID.csv                # REQUIRED: All cohort case IDs,  
|   |   |                                   extracted from supplementary table 5 listing all TCGA case IDs
│   │   └── [10-15. Additional supplementary files] # OPTIONAL
│   │
│   └── TCGA/                                # TCGA genomic data
│       ├── Clinical data/                   # Clinical information (optional). If available can extract clinical data from here
│       │
│       ├── Gene level CNV/                  # REQUIRED: Copy number variation data
│       │   ├── gdc_sample_sheet.2025-11-03.tsv      # Sample manifest
│       │   └── [Patient folders]/           # Individual patient CNV files, limited to Nulton et al TCGA case IDs
│       │       └── *.tsv                    # gene-level CNV scores for calculating GISTIC scores
│       │
│       └── SOM/                             # REQUIRED: Somatic mutation data
│           ├── cohortMAF.2025-07-29.maf     # Original MAF file from TCGA
│           ├── nulton_somatic_mutation_cohort.csv   # Filtered to Nulton cohort (generated)
│           └── gencode.v48.annotation.gtf   # Gene annotations, extracted from gencode to determine chromosme lengths
│
├── Results/                                 # OUTPUT DATA (pipeline generates)
│   │
│   ├── HPV results/                         # HPV stratification results
│   │   ├── HPV positive patients.csv        # Generated by 01: List of HPV+ case IDs
│   │   └── HPV negative patients.csv        # Generated by 01: List of HPV- case IDs
│   │
│   ├── CNV results/                         # Copy number variation results
│   │   ├── HPV positive CNV top genes.csv   # Generated by 02: Significant HPV+ CNV genes
│   │   ├── HPV negative CNV top genes.csv   # Generated by 02: Significant HPV- CNV genes
│   │   ├── HPV Positive Top Direct Drug Candidates Aggregated.csv    # Generated by 02.50
│   │   ├── HPV Negative Top Direct Drug Candidates Aggregated.csv    # Generated by 02.50
│   │   ├── HPV Positive Top Indirect Drug Candidates Aggregated.csv  # Generated by 02.50
│   │   └── HPV Negative Top Indirect Drug Candidates Aggregated.csv  # Generated by 02.50
│   │
│   ├── SOM results/                         # Somatic mutation results
│   │   ├── HPV positive top genes.csv       # Generated by 03: Significant HPV+ SOM genes
│   │   ├── HPV negative top genes.csv       # Generated by 03: Significant HPV- SOM genes
│   │   ├── hpv_positive_som_top_direct_drug_candidates_agg.csv    # Generated by 03.5
│   │   ├── hpv_negative_som_top_direct_drug_candidates_agg.csv    # Generated by 03.5
│   │   ├── hpv_positive_som_top_indirect_drug_candidates_agg.csv  # Generated by 03.5
│   │   └── hpv_negative_som_top_indirect_drug_candidates_agg.csv  # Generated by 03.5
│   │
│   ├── HPV positive gene results.csv        # Generated by 05: Final unified HPV+ genes (CNV+SOM)
│   ├── HPV negative gene results.csv        # Generated by 05: Final unified HPV- genes (CNV+SOM)
│   │
│   ├── HPV Positive direct results.csv      # Generated by 05: All HPV+ direct drug candidates
│   ├── HPV Negative direct results.csv      # Generated by 05: All HPV- direct drug candidates
│   ├── HPV Positive indirect results.csv    # Generated by 05: All HPV+ indirect drug candidates
│   ├── HPV Negative indirect results.csv    # Generated by 05: All HPV- indirect drug candidates
│   │
│   ├── HPV_Positive_Direct_Top50_DrugBank_Verified.csv    # Generated by 06: Top 50 HPV+ direct
│   ├── HPV_Negative_Direct_Top50_DrugBank_Verified.csv    # Generated by 06: Top 50 HPV- direct
│   │
│   ├── HPV_Positive_Top50_PPI_Validated.csv               # Generated by 07: Top 50 HPV+ indirect
│   ├── HPV_Negative_Top50_PPI_Validated.csv               # Generated by 07: Top 50 HPV- indirect
│   │
│   └── [Legacy individual result files]:
│       ├── hpv_pos_amp_top_drugBank_drug_candidates.csv   # Individual CNV amp results
│       ├── hpv_pos_del_top_drugBank_drug_candidates.csv   # Individual CNV del results
│       ├── hpv_pos_som_top_drugBank_drug_candidates.csv   # Individual SOM results
│       ├── hpv_neg_amp_top_drugBank_drug_candidates.csv   # Individual CNV amp results
│       ├── hpv_neg_del_top_drugBank_drug_candidates.csv   # Individual CNV del results
│       └── hpv_neg_som_top_drugBank_drug_candidates.csv   # Individual SOM results
│
└── Validation pipeline/                     # Literature validation (optional)
    ├── 00 extract_pmids.bash
    ├── 01 extract based on pmid.ipynb
    ├── 02 metastasis_GPU_full_extract_09_18_24.sh
    ├── 02 metastastis_GPU_full_extract_09_18_24.py
    ├── 03 data viewing.ipynb
    ├── pmids.txt
    ├── Data/                                # Literature mining input data
    └── Results/                             # Literature mining results
        ├── cleaned_extracted_targets_all_pub_after_2000_GPU_2b_gemma.csv  # Drug-gene from PubMed
        └── cleaned_extracted_combined_targets_all_pub_after_2000_GPU_2b_gemma.csv
```

### Required Input Data Sources

**1. DrugBank XML Database** (`Data/DGIDB/drug_bank.xml`)
- **Source**: https://go.drugbank.com/releases/latest
- **Access**: Requires free academic account
- **Format**: XML file (~1.5GB)
- **Content**: ~22,820 drug-gene interactions with actions and functions

**2. STRING PPI Database** (`Data/Protein-protein interaction data/`)
- **Source**: https://string-db.org/cgi/download
- **Version**: v12.0 (Human, Homo sapiens, organism 9606)
- **Required Files**:
  - `9606.protein.links.v12.0.txt` (~800MB)
  - `9606.protein.info.v12.0.txt` (~20MB)
  - `9606.protein.aliases.v12.0.txt` (~100MB)

**3. TCGA HNSC Data** (`Data/TCGA/`)
- **Source**: https://portal.gdc.cancer.gov/
- **Project**: TCGA-HNSC (Head and Neck Squamous Cell Carcinoma)
- **Required Data Types**:
  - **CNV**: Gene-level copy number variation (GISTIC2 scores)
    - Download via GDC Data Portal: Data Category = "Copy Number Variation"
    - File Type = "Gene Level Copy Number" (individual patient TSV files)
  - **SOM**: Somatic mutation data (MAF format)
    - Download via GDC Data Portal: Data Category = "Simple Nucleotide Variation"
    - File Type = "Masked Somatic Mutation" (cohort-level MAF file)

**4. Chromosome lenghts (Data/TCGA/SOM/gencode.v48.annotation):**
- Source: https://www.gencodegenes.org
- Version: Release 49 (GRCh38.p14)
- Required data files:
   - comprehensive gene annotation
      - comprehensive gene annotation on refernce chromosomes
   - provides length of genes for analysis 

**5. Nulton et al. Supplementary Data** (`Data/Supplementary data Nulton/`)
- **Source**: https://pmc.ncbi.nlm.nih.gov/articles/PMC5392278/
- **Citation**: Nulton TJ, et al. (2017). Oncotarget. 8(11):17684-17699
- **Required Files**:
  - `2. HNC HPV Types.csv`: HPV+ patient identifiers
  - `TCGA CASE ID.csv`: Complete cohort case list

**6. Literature Validation** (`Validation pipeline/`)
- **Inputs**: utilizes pubmed IDs for Custom GPU-accelerated PubMed mining pipeline
- **Output**: Requires heavy processing power to determine genes asociated with HNC based on public literature analysis


### Output File Descriptions

**Key Final Outputs** (used for publication/analysis):

| File | Generated By | Description |
|------|--------------|-------------|
| `HPV positive gene results.csv` | File 05 | Final unified list of significant genes in HPV+ cohort (CNV + SOM) |
| `HPV negative gene results.csv` | File 05 | Final unified list of significant genes in HPV- cohort (CNV + SOM) |
| `HPV Positive direct results.csv` | File 05 | All direct drug candidates for HPV+ (drug→gene) |
| `HPV Negative direct results.csv` | File 05 | All direct drug candidates for HPV- (drug→gene) |
| `HPV Positive indirect results.csv` | File 05 | All indirect drug candidates for HPV+ (drug→target→gene via PPI) |
| `HPV Negative indirect results.csv` | File 05 | All indirect drug candidates for HPV- (drug→target→gene via PPI) |
| `HPV_Positive_Direct_Top50_DrugBank_Verified.csv` | File 06 | **Top 50 HPV+ direct drugs** with DrugBank action verification |
| `HPV_Negative_Direct_Top50_DrugBank_Verified.csv` | File 06 | **Top 50 HPV- direct drugs** with DrugBank action verification |
| `HPV_Positive_Top50_PPI_Validated.csv` | File 07 | **Top 50 HPV+ indirect drugs** with PPI network validation |
| `HPV_Negative_Top50_PPI_Validated.csv` | File 07 | **Top 50 HPV- indirect drugs** with PPI network validation |

**Intermediate Outputs** (used within pipeline):

- `Results/HPV results/`: HPV stratification (Generated in File 01)
- `Results/CNV results/`: CNV-based gene and drug findings (Generated in Files 02, 02.50)
- `Results/SOM results/`: SOM-based gene and drug findings (Generated in Files 03, 03.5)
- Legacy individual result files: Pre-aggregation drug candidates

---


## File-by-File Breakdown

### **00 Data viewing.ipynb**
**Purpose:** Initial data exploration and DrugBank database parsing.

**Key Functions:**
- `structure_drug_bank_data()`: Parses the DrugBank XML file to extract drug-gene interactions including drug names, gene targets, polypeptide information, action mechanisms (inhibitor, antagonist, agonist, etc.), and specific molecular functions.

**Inputs:**
- `Data/DGIDB/drug_bank.xml`: DrugBank XML database containing ~22,820 drug-gene interactions
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`: STRING PPI network links
- `Data/Protein-protein interaction data/9606.protein.info.v12.0.txt`: Protein information
- `Data/Protein-protein interaction data/9606.protein.aliases.v12.0.txt`: Protein name aliases
- `Data/TCGA/Gene level CNV/`: CNV data files for initial exploration, clinical data is taken from here. Limited to Nulton et. al cohort case IDs
- `Data/TCGA/SOM/cohortMAF.2025-07-29.maf`: Somatic mutation data for initial viewing

**Outputs:**
- DrugBank Structured DataFrame with columns: `drug`, `polypeptide`, `gene`, `gene_description`, `action`, `specific_function`

**Key Operations:**
- Loads DrugBank XML using ElementTree parser with namespace handling
    - Extracts drug targets and polypeptide information for viewing
    - Handles cases where polypeptide data is absent (direct gene targeting)
- Views PPI data structure and connectivity
- Explores CNV data format (GISTIC scores)
- Views somatic mutation data structure (MAF format)
- explores clinical data for distribution of:
    - age
    - gender
    - diagnosis

**Libraries:** pandas, numpy, xml.etree.ElementTree, matplotlib, plotly, scipy, statsmodels, networkx

---

### **01 determine HPV status.ipynb**
**Purpose:** Stratify TCGA HNSC patient cohort by HPV status using validated data from Nulton et al. (2017).

**Key Data Sources:**
- Nulton et al. paper (PMC5392278): Provides validated HPV+ cases (72 patients)
- `Data/Supplementary data Nulton/2. HNC HPV Types.csv`: HPV+ case identifiers
- `Data/Supplementary data Nulton/TCGA CASE ID.csv`: All cohort case identifiers
- `Data/TCGA/SOM/cohortMAF.2025-07-29.maf`: Somatic mutation data for the cohort

**Key Operations:**
- Loads paper-identified HPV+ case IDs from Nulton supplementary data
- Loads all TCGA case IDs from the cohort
- Converts TCGA barcodes to case ID format (first 3 segments: TCGA-XX-XXXX)
- Calculates HPV negative cases by set difference: `all_cases - HPV+_cases`
- Filters somatic mutation cohort (originally all HNC patients in TCGA) to Nulton cohort patients
- Exports stratified patient lists for downstream analysis

**Outputs:**
- `Results/HPV results/HPV positive patients.csv`: 72 HPV+ case IDs based on Nulton et al analysis
- `Results/HPV results/HPV negative patients.csv`: HPV- case IDs (remaining cohort)
- `Data/TCGA/SOM/nulton_somatic_mutation_cohort.csv`: Filtered somatic mutations for the Nulton cohort

**Statistics:**
- HPV+ cases: 72 patients (highly validated)
- Total cohort: 520 patients
- HPV- cases:  448 patients

**Libraries:** pandas, matplotlib, plotly

---

### **02 CNV identify mutation gene.ipynb**
**Purpose:** Identify significantly amplified and deleted genes in HPV+ and HPV- cohorts from copy number variation (CNV) data.

**Key Statistical Methods:**

1. **Binomial Test:** Tests if the CNV of gene amplification/deletion in a cohort exceeds background rates.
   - Null hypothesis: Gene alteration = background rate
   - Alternative hypothesis: Gene alteratio > background rate (right-tailed test)
   
2. **Multiple Testing Correction:** Uses Benjamini-Hochberg FDR correction to control false discovery rate across thousands of genes tested.

3. **Empirical Permutation Testing:** Validates statistical significance by permuting CNV status labels 1,000 times to generate null distribution.

4. **Calculates GISTIC type scores**: calculates GISTIC score as the amplification value log2(CNV) summed across the cohort multiplied by the frequency of amplification/deletion across the cohort

**Key Operations:**
- Loads TCGA gene-level CNV data from individual patient files
- Stratifies samples by HPV status (HPV+ vs HPV-) based on Nulton et al analysis
- Calculates gene-level amplification/deletion frequencies per cohort
- Performs binomial testing for each gene  significant CNV (CNV>4, or CNV<1) to background
- Applies FDR correction (Benjamini-Hochberg) to control for multiple testing
- Runs empirical permutation tests (1,000 iterations) to validate significance
- Calculate GISTIC scores based on CNV values and alteration frequencies for downstream analysis
- Identifies top significantly altered genes (q-value < 0.05, empirical FDR < 0.05)
- Merges final dataframe with gene chromosome coverage for consideration

**Inputs:**
- `Data/TCGA/Gene level CNV/`: Directory containing individual patient CNV files (TSV format with GISTIC scores)
- `Results/HPV results/HPV positive patients.csv`: HPV+ case IDs
- `Results/HPV results/HPV negative patients.csv`: HPV- case IDs

**Outputs:**
- `Results/CNV results/HPV positive CNV top genes.csv`: Significantly amplified/deleted genes in HPV+ cohort
- `Results/CNV results/HPV negative CNV top genes.csv`: Significantly amplified/deleted genes in HPV- cohort

**Key Columns in Output:**
- `gene_name`: Gene symbol
- `MUT_TYPE`: AMPLIFICATION or DELETION
- `Cohort_Frequency`: Proportion of patients with alteration
- `Normalized_Count`: Count of patients with alteration
- `q_value`: FDR-corrected p-value (Benjamini-Hochberg)
- `empirical_q_value`: FDR-corrected empirical p-value from permutation testing
- `GISTIC`: GISTIC score for the gene
- `normalized_gistic_score`: Min-max normalized GISTIC score

**Thresholds:**
- Significant GISTIC amplification: > 4
- Significant GISTIC deletion: < 1
- Statistical significance: q_value < 0.05 AND empirical_q_value < 0.05

**Libraries:** pandas, scipy.stats (binomtest), statsmodels.stats.multitest (multipletests), numpy, matplotlib, plotly

---

### **02.2 CNV key mutation identification.ipynb**
**Purpose:** Exploratory analysis and threshold refinement for CNV gene results to select top candidate genes based on multiple criteria.

**Key Functions:**

**`plot_score_distribution(df)`**
- Visualizes distribution of key metrics across all significant CNV genes
- Plots: frequency_percentage, gistic_score, p-value, q-value, empirical_q_value, coverage_percentage
- Adds mean and 95th percentile reference lines
- Uses log-scale y-axis for better visibility of distributions

**`plot_score_distribution_with_cutoff(df, cutoff)`**
- Same as `plot_score_distribution()` but with custom cutoff lines overlaid
- Helps visualize how cutoff thresholds filter the gene set
- Cutoff dictionary contains threshold values for each metric

**`plot_gistic_distribution(df, title)`**
- Box plot showing GISTIC score distribution per gene using Plotly
- Interactive visualization for exploring individual gene scores
- Adds horizontal cutoff line for threshold reference

**Key Operations:**

1. **Load CNV Results:**
   - HPV+ amplification and deletion genes from File 02
   - HPV- amplification and deletion genes from File 02
   - DrugBank and PPI databases for druggability assessment

2. **Exploratory Visualization:**
   - Score distribution plots for all metrics
   - Scatter plots: GISTIC vs frequency_percentage, GISTIC vs q-value
   - Identify genes available in DrugBank and PPI databases

3. **Define Cutoff Thresholds:**
   Based on distribution characteristics of GISTIC scores and frequency percentage:
   
   **HPV+ Amplification:**
   - frequency_percentage ≥ 30%
   - gistic_score ≥ 0.296
   - q_value ≤ 0.05
   - empirical_q_value ≤ 0.05
   
   **HPV+ Deletion:**
   - frequency_percentage ≥ 12%
   - gistic_score ≥ 0.091
   - q_value ≤ 0.05
   - empirical_q_value ≤ 0.05
   
   **HPV- Amplification:**
   - frequency_percentage ≥ 35%
   - gistic_score ≥ 0.31
   - q_value ≤ 0.05
   - empirical_q_value ≤ 0.05
   
   **HPV- Deletion:**
   - frequency_percentage ≥ 22.5%
   - gistic_score ≥ 0.12
   - q_value ≤ 0.05
   - empirical_q_value ≤ 0.05

4. **Filter Top Genes:**
   - Apply all cutoff criteria simultaneously (AND logic)
   - Genes must pass all thresholds to be selected
   - Sort by GISTIC score and frequency_percentage for prioritization

5. **Visualization of Top Genes:**
   - Horizontal bar charts showing top genes by GISTIC score
   - Horizontal bar charts showing top genes by frequency_percentage
   - Cutoff lines overlaid for reference

6. **Export Top Gene Sets:**
   - Filtered gene lists for each category (HPV+/- × amplification/deletion)
   - Used as refined input for drug repurposing analysis in File 02.50

**Rationale for Cutoffs:**

- **Frequency_percentage**: Ensures mutations occur in sufficient proportion of patients (clinical relevance)
- **GISTIC_score**: Reflects magnitude of copy number alteration (biological impact)
- **Statistical significance**: Both parametric (q_value) and empirical validation required
- **HPV- vs HPV+**: segregated cohorts for analysis
- **Amplification vs Deletion**: Different thresholds due to different baseline rates

**Inputs:**
- `Results/CNV results/HPV positive CNV genes.csv`: All significant HPV+ CNV genes from File 02
- `Results/CNV results/HPV negative CNV genes.csv`: All significant HPV- CNV genes from File 02
- `Data/DGIDB/drug_bank.xml`: DrugBank database
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`: STRING PPI database

**Outputs:**
- `Results/CNV results/HPV positive amplification top genes.csv`: Top HPV+ amplification genes
- `Results/CNV results/HPV positive deletion top genes.csv`: Top HPV+ deletion genes
- `Results/CNV results/HPV negative amplification top genes.csv`: Top HPV- amplification genes
- `Results/CNV results/HPV negative deletion top genes.csv`: Top HPV- deletion genes

**Key Metrics Explained:**

- **frequency_percentage**: Percentage of patients in cohort with the CNV alteration
- **gistic_score**: GISTIC2.0 normalized copy number score (mean across patients with alteration)
- **coverage_percentage**: Percentage of genome coverage (used for normalization)
- **Amplification_sum**: Total log2(CNV) summed across all samples with amplification

**Use Case:**
This is a quality control and refinement notebook that:
- Ensures only high-confidence genes proceed to drug repurposing analysis
- Balances statistical significance with clinical relevance (frequency)
- Provides visualizations for understanding gene selection criteria
- Reduces false positives by requiring genes to pass multiple filters
- Creates cohort-specific filtered gene lists optimized for druggability analysis

**Relationship to Pipeline:**
- **Receives**: Statistically significant genes from File 02
- **Refines**: Applies additional frequency and GISTIC magnitude thresholds
- **Provides**: High-confidence gene lists to File 02.50 for drug candidate identification

**Libraries:** pandas, matplotlib, plotly, numpy, sklearn.preprocessing (MinMaxScaler), xml.etree.ElementTree

---

### **02.50 CNV drug repurposing candidates copy.ipynb**
**Purpose:** Identify direct and indirect drug repurposing candidates based on significantly altered CNV genes.

**Key Statistical Methods:**

1. **Hypergeometric Test (Drug Enrichment):**
   - Tests if a drug targets more significant genes than expected by chance
   - Parameters:
     - `M`: Total number of genes in DrugBank
     - `K`: Number of significant genes identified from CNV analysis
     - `n`: Number of genes targeted by the drug
     - `x`: Number of significant genes targeted by the drug
   - Right-tailed test: P(X ≥ x)

2. **Empirical Permutation Testing (100,000 iterations):**
   - Randomly shuffles gene labels to generate null distribution
   - Calculates empirical p-value: proportion of permutations with enrichment ≥ observed
   - Validates statistical significance beyond hypergeometric assumptions

3. **Protein-Protein Interaction (PPI) Network Analysis:**
   - Uses STRING database (confidence ≥ 700) for indirect drug candidates
   - Connects drug targets to significant genes via PPI edges

**Key Functions:**
- `hypergeom_p_right_tail()`: Calculates hypergeometric p-value for drug enrichment
- `identify_significant_drug_candidates()`: Main function that:
  - Matches drug targets to significant genes (direct candidates)
  - Finds PPI connections for indirect candidates
  - Performs hypergeometric testing for each drug
  - Runs 100,000 permutation tests for empirical validation
  - Applies FDR correction (Benjamini-Hochberg)
  - Filters to significant drugs (hypergeom FDR < 0.05, empirical FDR < 0.05)

**Workflow:**

**Direct Drug Candidates:**
1. Match DrugBank drug targets to significant CNV genes
2. Calculate hypergeometric enrichment for each drug
3. Run 100,000 permutations to get empirical p-values
4. Apply FDR correction
5. Filter to FDR < 0.05 for both tests

**Indirect Drug Candidates:**
1. Find PPI connections (STRING confidence ≥ 700) between drug targets and significant genes
2. Calculate percentage of significant genes hit via PPI
3. Perform same statistical testing as direct candidates
4. Filter to FDR < 0.05

**Inputs:**
- `Results/CNV results/HPV positive CNV top genes.csv`: Significant HPV+ CNV genes
- `Results/CNV results/HPV negative CNV top genes.csv`: Significant HPV- CNV genes
- DrugBank structured data (from `structure_drug_bank_data()`)
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`: STRING PPI network links
- `Data/Protein-protein interaction data/9606.protein.info.v12.0.txt`: Protein information
- `Data/Protein-protein interaction data/9606.protein.aliases.v12.0.txt`: Protein aliases

**Outputs:**
- `Results/hpv_pos_amp_top_drugBank_drug_candidates.csv`: HPV+ amplification direct candidates
- `Results/hpv_pos_del_top_drugBank_drug_candidates.csv`: HPV+ deletion direct candidates
- `Results/hpv_neg_amp_top_drugBank_drug_candidates.csv`: HPV- amplification direct candidates
- `Results/hpv_neg_del_top_drugBank_drug_candidates.csv`: HPV- deletion direct candidates
- Indirect candidates for each category

**Key Output Columns:**
- `DRUG`: Drug name
- `GENE_TARGET`: Gene(s) directly targeted by drug
- `CONNECTED_TO (risk gene)`: Significant genes connected via PPI (indirect only)
- `NUM_DIRECT_TARGETS_HIT`: Number of significant genes targeted
- `PERCENTAGE_OF_TARGETS_HIT`: Percentage of significant genes targeted
- `ACTION`: DrugBank mechanism of action (inhibitor, antagonist, etc.)
- `SPECIFIC_FUNCTION`: Molecular function from DrugBank
- `drug_hypergeom_p_value`: Hypergeometric test p-value
- `drug_hypergeom_fdr`: FDR-corrected hypergeometric p-value
- `drug_empirical_p_value`: Empirical permutation p-value
- `drug_empirical_fdr`: FDR-corrected empirical p-value

**Filters Applied:**
- Excludes known head/neck cancer chemotherapy medications
- Requires both hypergeom FDR < 0.05 AND empirical FDR < 0.05ed to notebook)
- Distribution visualizations (plots)
- PPI confidence threshold ≥ 700 for indirect candidates

**Libraries:** pandas, numpy, scipy.stats (hypergeom), statsmodels.stats.multitest, xml.etree.ElementTree, networkx, matplotlib

---
### **03 SOM identify key mutation gene.ipynb**
**Purpose:** Identify significantly mutated genes from somatic mutation (SOM) data stratified by HPV status.

**Key Statistical Methods:**

1. **Binomial Test:** Tests if mutation frequency of a gene in the cohort exceeds background mutation rate.
   - Background rate calculated from total mutations across all genes and patients
   - Right-tailed test for over-representation

2. **Empirical Permutation Testing:** Shuffles HPV status labels 10,000 times to generate null distribution and validate significance.

3. **Multiple Testing Correction:** Benjamini-Hochberg FDR correction applied to control false discovery rate.

**Key Operations:**
- Loads somatic mutation data (MAF format) filtered to Nulton cohort
- Stratifies mutations by HPV status
- Calculates per-gene mutation frequencies in each cohort
- Computes background mutation rate: `total_mutations / (num_genes × num_patients)`
- Performs binomial testing for each gene
- Applies FDR correction (Benjamini-Hochberg)
- Runs empirical permutation tests (10,000 iterations) to validate significance
- Normalizes mutation frequencies for downstream analysis
- Identifies top significantly mutated genes (q-value < 0.05, empirical FDR < 0.05)

**Inputs:**
- `Data/TCGA/SOM/nulton_somatic_mutation_cohort.csv`: Somatic mutations filtered to Nulton cohort patients
- `Results/HPV results/HPV positive patients.csv`: HPV+ case IDs
- `Results/HPV results/HPV negative patients.csv`: HPV- case IDs

**Outputs:**
- `Results/SOM Results/HPV positive top genes.csv`: Significantly mutated genes in HPV+ cohort
- `Results/SOM Results/HPV negative top genes.csv`: Significantly mutated genes in HPV- cohort

**Key Columns in Output:**
- `Gene`: Gene symbol (Hugo symbol)
- `MUT_TYPE`: SOMATIC
- `Cohort_Frequency`: Proportion of patients with mutation in the gene
- `Normalized_Count`: Number of patients with mutation
- `Normalized_Cohort_Frequency`: Min-max normalized frequency
- `Adjusted_P_Value` (q_value): FDR-corrected p-value
- `Adjusted_Empirical_P_Value` (empirical_q_value): FDR-corrected empirical p-value

**Thresholds:**
- Statistical significance: Adjusted_P_Value < 0.05 AND Adjusted_Empirical_P_Value < 0.05

**Common Mutated Genes:** TP53, PIK3CA, CDKN2A, FAT1, NOTCH1 (typical in HNSC)

**Libraries:** pandas, scipy.stats (binomtest), statsmodels.stats.multitest, numpy, matplotlib, plotly

---

### **03.5 SOM drug repurpose.ipynb**
**Purpose:** Identify direct and indirect drug repurposing candidates based on significantly mutated somatic genes.

**Key Statistical Methods:** Same as 02.50 CNV drug repurposing (hypergeometric testing + 100,000 empirical permutations).

**Key Differences from 02.50:**
- Input: Somatic mutation (SOM) data instead of CNV data
- Mutation type: SOMATIC instead of AMPLIFICATION/DELETION
- Similar statistical pipeline and filtering criteria

**Key Functions:**
- `hypergeom_p_right_tail()`: Calculates hypergeometric p-value
- `identify_significant_drug_candidates()`: Same workflow as CNV version but adapted for somatic mutations

**Workflow:**
2. Match drug targets to mutated genes (direct candidates)
3. Find PPI connections for indirect candidates
4. Perform hypergeometric enrichment testing
5. Run 100,000 permutation tests for empirical validation
6. Apply FDR correction (Benjamini-Hochberg)
7. Filter to drugs with FDR < 0.05 for both tests

**Inputs:**
- `Results/SOM Results/HPV positive top genes.csv`: Significant HPV+ somatic genes
- `Results/SOM Results/HPV negative top genes.csv`: Significant HPV- somatic genes
- DrugBank structured data
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`: STRING PPI database
- `Data/Protein-protein interaction data/9606.protein.info.v12.0.txt`: Protein information
- `Data/Protein-protein interaction data/9606.protein.aliases.v12.0.txt`: Protein aliases

**Outputs:**
- `Results/hpv_pos_som_top_drugBank_drug_candidates.csv`: HPV+ somatic direct candidates
- `Results/hpv_neg_som_top_drugBank_drug_candidates.csv`: HPV- somatic direct candidates
- Indirect candidates for each category

**Key Output Columns:** Same as 02.50 CNV outputs, with `MUT_TYPE` = SOMATIC

**Libraries:** Same as 02.50

---

### **03.75 result viewing.ipynb**
**Purpose:** Exploratory analysis and visualization of somatic mutation (SOM) drug repurposing results to understand drug candidate characteristics and define scoring thresholds.

**Key Functions:**

**`define_cutoffs(drug_candidates_df, title)`**
- Analyzes distribution of drug candidate scores to define selection thresholds
- Generates visualizations for:
  - Drug type distribution (chemotherapy, immunotherapy, other)
  - Priority norm scores (composite drug prioritization metric)
  - Drug-gene interaction scores
  - DrugNome AI support scores (druggability prediction)
  - Cancer targetability scores
- Calculates statistical cutoffs using mean and quantile methods
- Returns dictionary of threshold values for filtering

**`display_top_genes()` and `display_top_genes_and_neighbors()`**
- Displays top genes with DrugBank/DGIdb coverage
- Maps protein-protein interaction (PPI) network neighbors
- Aggregates PPI connections per risk gene
- Filters by PPI confidence (combined_score > 700)

**Key Visualizations:**

1. **Drug Type Analysis:**
   - Bar charts showing counts and percentages of chemotherapy, immunotherapy, and other drugs
   - Unique drug counts by type

2. **Score Distributions:**
   - Priority norm score histograms with mean/median markers
   - Drug-gene interaction score distributions
   - Normalized score distributions
   - DrugNome AI support score distributions
   - Cancer targetability score distributions with quantile thresholds

3. **PPI Network Analysis:**
   - Risk gene coverage in PPI database
   - Immediate neighbor identification
   - Connection strength visualization

**Key Operations:**
1. Load SOM drug candidate results for HPV+ and HPV-
2. Merge with DrugNome AI oncology predictions
3. Flag chemotherapy and immunotherapy drugs
4. Generate distribution plots for all scoring metrics
5. Calculate threshold cutoffs:
   - Priority norm score: mean value
   - Drug-gene interaction score: mean value
   - DrugNome AI support: mean value
6. Display top genes with PPI network context
7. Aggregate immediate PPI neighbors for each risk gene

**Scoring Metrics Explained:**

- **PRIORITY_NORM_SCORE**: Composite normalized score combining multiple factors (FDR, frequency, GISTIC/mutation counts)
- **DRUG-GENE-INTERACTION_SCORE**: Strength of drug-gene interaction based on literature and database evidence
- **norm_DRUGNOMEAI SUPPORT**: DrugNome AI predicted druggability score (normalized)
- **Cancer_targetability**: Cancer-specific targetability score (higher = better cancer drug candidate)
- **CHEMO/IMMUNO**: Binary flags for known chemotherapy/immunotherapy drugs

**Threshold Selection Rationale:**
- Mean values used for most metrics (balanced selection)
- PPI confidence ≥ 700 (high-confidence interactions only)

**Inputs:**
- `Results/SOM results/HPV positive drug candidates.csv`: SOM drug candidates for HPV+
- `Results/SOM results/HPV negative drug candidates.csv`: SOM drug candidates for HPV-
- DrugNome AI oncology predictions (external druggability database)
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`: STRING PPI database

**Outputs:**
- Statistical threshold values (print)
- PPI network statistics (printed)
- Top genes with neighbor aggregation (displayed)

**Use Case:**
This is an exploratory/quality control notebook that helps researchers:
- Understand the characteristics of identified drug candidates
- Set appropriate thresholds for drug selection
- Visualize score distributions before final filtering
- Assess PPI network coverage of risk genes
- Identify known cancer drugs in the candidate list

**Libraries:** pandas, matplotlib, plotly

---

### **04 SOM and CNV results comparison.ipynb**
**Purpose:** Compare and integrate drug candidates identified from CNV (amplifications/deletions) and somatic mutation analyses.

**Key Analyses:**

1. **Gene-Level Overlap:**
   - Calculates overlap between CNV and SOM significant genes
   - Identifies genes with multiple mutation types (e.g., TP53 amplified AND mutated)
   - Stratified by HPV status

2. **Drug-Level Overlap:**
   - Identifies drugs that target genes from multiple mutation sources
   - Calculates overlap between amplification, deletion, and somatic drug candidates
   - Prioritizes drugs targeting genes with converging evidence

3. **Aggregation:**
   - Combines drug candidates across mutation types (CNV + SOM)
   - Groups by drug and concatenates targeted genes
   - Selects minimum FDR values across sources for prioritization

**Key Operations:**
- Loads CNV drug candidates (amp, del) for HPV+ and HPV-
- Loads SOM drug candidates for HPV+ and HPV-
- Calculates Venn diagram statistics for gene and drug overlaps
- Identifies drugs appearing in all three categories (amp, del, somatic)
- Aggregates information: concatenates gene targets, takes min FDR values
- Sorts by statistical significance (hypergeom FDR, empirical FDR)
- Counts number of unique targeted genes and connected genes per drug

**Inputs:**
- `Results/hpv_pos_amp_top_drugBank_drug_candidates.csv`
- `Results/hpv_pos_del_top_drugBank_drug_candidates.csv`
- `Results/hpv_pos_som_top_drugBank_drug_candidates.csv`
- `Results/hpv_neg_amp_top_drugBank_drug_candidates.csv`
- `Results/hpv_neg_del_top_drugBank_drug_candidates.csv`
- `Results/hpv_neg_som_top_drugBank_drug_candidates.csv`

**Outputs:**
- Overlap statistics (printed to notebook)
- Aggregated drug candidate tables (used for downstream analysis)

**Key Insights:**
- Drugs targeting genes mutated through multiple mechanisms have stronger biological rationale
- Overlap drugs are prioritized as having convergent evidence

**Libraries:** pandas, matplotlib, plotly

---

### **05 Final result creation.ipynb**
**Purpose:** Consolidate and aggregate all genetic results and drug candidates into final unified tables, adding literature validation from PubMed mining.

**Key Operations:**

1. **Gene Results Integration:**
   - Combines CNV and SOM significant genes for each cohort
   - Concatenates mutation types (e.g., "AMPLIFICATION, SOMATIC")
   - Takes minimum q-value and empirical q-value across sources
   - Validates genes against literature-extracted targets

2. **Direct Drug Candidates Aggregation:**
   - Merges CNV and SOM direct drug candidates
   - Groups by drug and aggregates gene targets
   - Combines mutation types and article counts
   - Concatenates PMIDs for literature traceability

3. **Indirect Drug Candidates Aggregation:**
   - Merges CNV and SOM indirect drug candidates
   - Aggregates gene targets and connected risk genes
   - Combines PPI-validated connections
   - Integrates literature validation metrics

4. **Literature Validation:**
   - Loads literature-extracted drug-gene interactions from GPU-accelerated NLP pipeline
   - Matches drug candidates to PubMed-validated targets
   - Adds literature-validated gene lists and article counts
   - Includes PMIDs for citation traceability

**Key Data Sources:**
- CNV results: HPV+/- amplification/deletion drug candidates
- SOM results: HPV+/- somatic mutation drug candidates
- Literature validation:
  - `Validation pipeline/Results/cleaned_extracted_targets_all_pub_after_2000_GPU_2b_gemma.csv`: Drug-gene pairs extracted from PubMed
  - `Validation pipeline/Results/cleaned_extracted_combined_targets_all_pub_after_2000_GPU_2b_gemma.csv`: Combined targets

**Aggregation Strategy:**
- Group by `DRUG` 
- Concatenate gene lists (comma-separated, deduplicated)
- Concatenate mutation types (deduplicated)
- Take minimum FDR values (most significant)
- Sum article counts
- Concatenate PMIDs (deduplicated, cleaned)

**Inputs:**
- All outputs from files 02-04 (CNV and SOM drug candidates)
- `Results/CNV results/HPV positive CNV top genes.csv`
- `Results/CNV results/HPV negative CNV top genes.csv`
- `Results/SOM Results/HPV positive top genes.csv`
- `Results/SOM Results/HPV negative top genes.csv`
- Literature validation CSVs

**Outputs:**
- `Results/HPV positive gene results.csv`: Unified HPV+ significant genes (CNV + SOM)
- `Results/HPV negative gene results.csv`: Unified HPV- significant genes (CNV + SOM)
- `Results/HPV Positive direct results.csv`: Aggregated HPV+ direct drug candidates
- `Results/HPV Negative direct results.csv`: Aggregated HPV- direct drug candidates
- `Results/HPV Positive indirect results.csv`: Aggregated HPV+ indirect drug candidates (via PPI)
- `Results/HPV Negative indirect results.csv`: Aggregated HPV- indirect drug candidates (via PPI)

**Key Output Columns (Final Results):**
- `DRUG`: Drug name
- `GENE_TARGET` / `LITERATURE_GENE_TARGETS`: Genes targeted by drug (DrugBank and/or literature)
- `LITERATURE_VALIDATED_GENE_TARGETS`: Genes confirmed in PubMed literature
- `CONNECTED_TO (risk gene)`: Risk genes connected via PPI (indirect only)
- `MUT_TYPE`: Mutation type(s) (AMPLIFICATION, DELETION, SOMATIC)
- `NUMBER_OF_ARTICLES`: Count of PubMed articles supporting drug-gene interaction
- `PMID`: PubMed IDs (comma-separated)
- `drug_empirical_fdr`: FDR-corrected empirical p-value
- `drug_hypergeom_fdr`: FDR-corrected hypergeometric p-value
- `PERCENTAGE_OF_TARGETS_HIT`: Percentage of significant genes targeted

**Libraries:** pandas

---

### **06 Graph direct results.ipynb**
**Purpose:** Visualize direct drug-gene targeting relationships and generate DrugBank-verified tables for direct drug candidates.

**Key Functions:**

**`create_direct_gene_table(results_df, drug_bank_df, hpv_gene_results, top_n=50, cohort_name='')`**
- Creates top N direct drug candidate table with DrugBank action verification
- Handles column name variations (`LITERATURE_VALIDATED_GENE_TARGETS` vs `LITERATURE_GENE_TARGETS`)
- Performs per-gene DrugBank action verification:
  - Searches DrugBank for each literature-validated target
  - Marks genes without DrugBank annotation as "GENE: UNKNOWN"
  - Keeps all drugs (does not filter by action availability)
- Maps mutation types from HPV gene results to validated targets
- Collects specific molecular functions from DrugBank (limit 3)
- Cleans and formats PMIDs
- Sorts by `drug_empirical_fdr` (ascending)

**Visualization: Bipartite Drug-Gene Network**
- Drugs positioned on left, genes on right
- Drugs sorted by degree (number of genes targeted, descending)
- Node colors represent mutation types (amplification: red, deletion: blue, somatic: green)
- Node sizes proportional to number of connections
- Edge thickness represents strength of association
- Includes gene degree counts and mutation type labels

**Key Operations:**
1. Load direct results and gene results for HPV+ and HPV-
2. Parse DrugBank XML for action and function verification
3. Create top 50 tables with per-gene action verification:
   - Verify each gene target against DrugBank
   - Mark missing actions as "GENE: UNKNOWN"
   - Map mutation types from gene results
   - Collect molecular functions
   - Clean PMIDs
4. Export tables to CSV
5. Generate bipartite network graphs for visualization

**Inputs:**
- `Results/HPV Positive direct results.csv`
- `Results/HPV Negative direct results.csv`
- `Results/HPV positive gene results.csv`
- `Results/HPV negative gene results.csv`
- `Data/DGIDB/drug_bank.xml`

**Outputs:**
- `Results/HPV_Positive_Direct_Top50_DrugBank_Verified.csv`: Top 50 HPV+ direct drugs with DrugBank actions
- `Results/HPV_Negative_Direct_Top50_DrugBank_Verified.csv`: Top 50 HPV- direct drugs with DrugBank actions

**Table Columns:**
- `DRUG`: Drug name
- `MUT_TYPE`: Mutation type(s) of targeted genes
- `Literature-Validated Gene Targets`: Genes confirmed in literature
- `Number of Validated Targets`: Count of literature-validated targets
- `Article Count`: Number of PubMed articles
- `PMIDs`: PubMed identifiers
- `ACTION`: DrugBank actions per gene (format: "GENE1: inhibitor; GENE2: UNKNOWN")
- `SPECIFIC_FUNCTION`: Molecular functions (semicolon-separated, max 3)
- `Drug Empirical FDR`: Statistical significance

**Key Design Decision:**
- Changed from filtering drugs without actions to marking individual genes as "GENE: UNKNOWN"
- Rationale: Literature validation is sufficient even without DrugBank confirmation
- Provides transparency about which targets lack DrugBank annotation

**Libraries:** pandas, numpy, matplotlib, networkx

---

### **07_sankey_diagram_builder.ipynb**
**Purpose:** Visualize indirect drug→target→risk gene pathways through Sankey diagrams and generate comprehensive PPI-validated tables showing literature-validated connections only.

**Critical Data Philosophy:**
- **Only uses literature-validated gene targets** (`LITERATURE_GENE_TARGETS` column)
- **Only uses literature-validated risk genes** (`RISK_GENE_LITERATURE_GENE_TARGETS` column)
- All connections must be supported by both PubMed literature AND STRING PPI database
- Ensures all pathways shown are evidence-based and biologically validated

---

**Key Functions:**

**1. `group_gene_families(gene_list, min_family_size=3)`**
- Groups related genes into families for cleaner Sankey visualization
    - Identifies gene families (e.g., HLA-A, HLA-B, HLA-C → HLA family)
- Only groups if family has ≥ min_family_size members
- Returns mapping: individual gene → family name
- Reduces visual clutter in diagrams with many related genes

**2. `prepare_sankey_data(results_df, ppi_set, top_n=50, required_drugs=None)`**
**Purpose:** Core data preparation function that builds the network structure for Sankey visualization.

**Detailed Workflow:**
1. **Sort and Rank Drugs:**
   - Sorts by `drug_empirical_fdr` (ascending) and `PERCENTAGE_OF_TARGETS_HIT` (descending)
   - Prioritizes statistically significant drugs with high target coverage

2. **Process Required Drugs First:**
   - If `required_drugs` list provided, processes these drugs first
   - Ensures specific drugs of interest are included regardless of ranking

3. **Literature-Validated Gene Parsing:**
   - Extracts `LITERATURE_GENE_TARGETS`: Genes with PubMed evidence of drug interaction
   - Extracts `RISK_GENE_LITERATURE_GENE_TARGETS`: Risk genes with literature validation
   - **Only these literature-validated genes are used** (not all database genes) ensuring secondary validation

4. **PPI Validation:**
   - For each drug, double checks if validated gene targets connect to validated risk genes via PPI (confidence ≥ 700)
   - Creates two link types:
     - `drug_to_target`: Drug → Literature-validated gene target
     - `target_to_risk`: Literature-validated gene target → Literature-validated risk gene (via PPI)
   - **Only includes connections supported by both literature AND PPI**

5. **Filtering for Visualization:**
   - Removes drugs with no valid PPI connections
   - For drugs with > 15 gene targets, keeps top 15 by connection count (reduces clutter) (eg. fostamatinib having over 40 gene targets)
   - Removes genes appearing in both target and risk layers (prevents circular flows)

6. **Gene Family Grouping:**
   - Applies `group_gene_families()` to collapse related genes
   - Creates legend mapping: family → individual genes
   - Re-aggregates links after grouping

7. **Returns Dictionary:**
   - `link_counts`: DataFrame with source→target connections and link types
   - `drugs`: List of drugs with valid connections
   - `gene_targets`: List of literature-validated gene targets (or families)
   - `risk_genes`: List of literature-validated risk genes
   - `top_df`: Filtered results DataFrame
   - `family_to_genes`: Mapping for legend display

**3. `create_combined_sankey(data_dict, title, height=1400, width=2400)`**
**Purpose:** Creates a unified Sankey diagram showing all drugs in one comprehensive view.

**Visualization Details:**
- **Left Column (Blue nodes)**: Drugs
- **Middle Column (Green nodes)**: Literature-validated gene targets (direct drug targets from PubMed)
- **Right Column (Red nodes)**: Literature-validated risk genes (connected via PPI)
- **Flows**: Represent drug→target→risk gene pathways
- **Gene Family Legend**: Shows which individual genes are grouped into families

**Node Positioning:**
- Fixed positions: drugs (x=0.001), targets (x=0.5), risk genes (x=0.999)
- Ensures proper left-to-right flow visualization

**Color Scheme:**
- Blue: Drugs
- Green: Gene targets (literature-validated)
- Red: Risk genes (literature-validated)
- Link transparency: rgba(0,0,0,0.2)

**Interactive Features:**
- Hover to see node labels
- Click-drag to rearrange nodes
- Zoom and pan enabled

**4. `create_individual_sankeys(data_dict, drug_list=None, title_prefix='', ncols=2, height=2200, width=2000, risk_gene_threshold=0)`**
**Purpose:** Creates a grid of individual Sankey diagrams, one per drug, for detailed pathway exploration.

**Grid Layout:**
- Each subplot shows one drug's complete pathway network
- `ncols`: Number of columns in grid (default: 2)
- Automatically calculates rows based on number of drugs
- Subplot titles show individual drug names

**Per-Drug Filtering:**
- For drugs with > 15 gene targets, applies `risk_gene_threshold`
- Keeps only gene targets with ≥ threshold connections to risk genes
- Removes targets with no downstream connections after filtering
- Ensures each diagram shows only meaningful pathways

**Node Ordering:**
- Layer 1: Drug (single node)
- Layer 2: Literature-validated gene targets for this drug
- Layer 3: Literature-validated risk genes connected via PPI
- Maintains strict left-to-right flow

**Visualization Features:**
- Uniform link thickness (value=1 for all links, focus on topology not weight)
- `arrangement='snap'` for optimized node positioning
- Per-drug gene family legend
- Larger font sizes for readability

**5. `create_filtered_top_table(results_df, ppi_set, drug_bank_df, top_n=50, cohort_name='')`**
**Purpose:** Generate publication-ready table with DrugBank action verification for top indirect drug candidates.

**Table Generation Workflow:**

1. **Load Gene Results:**
   - Imports HPV gene results to map mutation types
   - Creates gene→MUT_TYPE dictionary

2. **Sort and Select Top Drugs:**
   - Sorts by `drug_empirical_fdr` (ascending) and `PERCENTAGE_OF_TARGETS_HIT` (descending)
   - Selects top N drugs

3. **Parse Literature-Validated Genes:**
   - Extracts `LITERATURE_GENE_TARGETS`: Genes with PubMed evidence
   - Extracts `RISK_GENE_LITERATURE_GENE_TARGETS`: Risk genes with literature validation
   - **Critical:** Only uses these validated genes, not all database entries

4. **PPI Validation:**
   - Checks which gene targets connect to risk genes via STRING PPI (confidence ≥ 700)
   - Creates list of `validated_targets`: Gene targets with PPI-confirmed connections

5. **DrugBank Action Verification (Per-Gene):**
   - For each validated target gene:
     - Searches DrugBank for drug-gene interaction
     - Extracts action (inhibitor, antagonist, modulator, etc.)
     - If action found: adds "GENE: action"
     - If no action: adds "GENE: UNKNOWN"
   - Aggregates: "GENE1: inhibitor; GENE2: UNKNOWN; GENE3: modulator"

6. **Specific Function Collection:**
   - Extracts molecular functions from DrugBank for validated targets
   - Limits to 3 functions to keep table readable
   - Format: "function1; function2; function3"

7. **Mutation Type Mapping:**
   - Maps validated risk genes to their mutation types (AMPLIFICATION, DELETION, SOMATIC)
   - Deduplicates: splits compound types like "AMPLIFICATION, DELETION"
   - Joins unique types with ", "

8. **Article Count and PMID Cleaning:**
   - Converts article counts to integers (not strings)
   - Cleans PMIDs: removes 'nan', strips whitespace
   - Separates gene target PMIDs and risk gene PMIDs

9. **Table Assembly:**
   - Creates row with all validated information
   - Adds ALL drugs with PPI validation (not filtered by DrugBank action)
   - Returns DataFrame sorted by statistical significance

**Table Output:**
- All columns contain only literature-validated and PPI-validated information
- Transparency: Shows "UNKNOWN" for genes lacking DrugBank annotation
- Rationale: Literature + PPI validation is sufficient even without DrugBank confirmation

---

**Complete Pipeline Workflow:**

1. **Load Data:**
   - Indirect results (HPV+ and HPV-)
   - Gene results for mutation type mapping
   - DrugBank XML database
   - STRING PPI database (map protein IDs to gene names)

2. **Create PPI Validation Set:**
   - Load protein-protein interaction links
   - Filter to confidence ≥ 700
   - Create bidirectional set: {(geneA, geneB), (geneB, geneA)}

3. **Generate Tables:**
   - Run `create_filtered_top_table()` for HPV+ and HPV-
   - Export top 50 tables with DrugBank verification

4. **Prepare Sankey Data:**
   - Run `prepare_sankey_data()` for HPV+ and HPV-
   - Process top 10-15 drugs for visualization
   - Apply gene family grouping

5. **Create Visualizations:**
   - **Combined Sankey:** All drugs in one comprehensive view
   - **Individual Sankeys:** Grid of per-drug pathway diagrams
   - Generate for both HPV+ and HPV-

6. **Data Quality Checks:**
   - Verify PMID completeness in exported CSVs
   - Confirm no data loss during export
   - Validate that only literature-validated genes appear in outputs

**Inputs:**
- `Results/HPV Positive indirect results.csv`
- `Results/HPV Negative indirect results.csv`
- `Results/HPV positive gene results.csv`
- `Results/HPV negative gene results.csv`
- `Data/DGIDB/drug_bank.xml`
- `Data/Protein-protein interaction data/9606.protein.links.v12.0.txt`
- `Data/Protein-protein interaction data/9606.protein.info.v12.0.txt`
- `Data/Protein-protein interaction data/9606.protein.aliases.v12.0.txt`

**Outputs:**

**Tables:**
- `Results/HPV_Positive_Top50_PPI_Validated.csv`: Top 50 HPV+ indirect drugs
- `Results/HPV_Negative_Top50_PPI_Validated.csv`: Top 50 HPV- indirect drugs

**Sankey Diagrams (Interactive Plotly HTML):**
- Combined Sankey: All drugs in unified view (HPV+ and HPV-)
- Individual Sankeys: Grid of per-drug pathway diagrams (HPV+ and HPV-)

**Table Columns:**
- `DRUG`: Drug name
- `MUT_TYPE`: Mutation type(s) of connected risk genes (from literature-validated risk genes only)
- `Literature-Validated Gene Targets`: Direct targets of drug (from PubMed)
- `Number of Validated Targets`: Count of literature-validated targets
- `Literature-Validated Risk Genes`: Risk genes with PubMed evidence connected via PPI
- `Number of Validated Risk Genes`: Count of literature-validated risk genes
- `Gene Target Article Count`: Articles supporting gene target validation
- `Risk Gene Article Count`: Articles supporting risk gene validation
- `Gene Target PMIDs`: PubMed IDs for gene target validation
- `Risk Gene PMIDs`: PubMed IDs for risk gene validation
- `ACTION`: DrugBank actions per target (format: "GENE1: inhibitor; GENE2: UNKNOWN")
- `SPECIFIC_FUNCTION`: Molecular functions from DrugBank (semicolon-separated, max 3)
- `Drug Empirical FDR`: Statistical significance from permutation testing
- `Percent Targets Hit`: Percentage of literature-validated risk genes connected via PPI

**PPI Validation:**
- Uses STRING database v12.0
- Confidence threshold: ≥ 700 (high confidence)
- Connects drug targets to risk genes through one PPI edge
- Validates that literature-supported connections are also PPI-supported

**Key Design Decisions:**
- Per-gene action verification (not per-drug filtering)
- UNKNOWN marking for genes without DrugBank actions
- Rationale: PPI validation and literature validation are sufficient
- Provides granular information about which targets lack DrugBank annotation
- **Only literature-validated genes used throughout entire pipeline**

**Data Quality Verification:**
- PMID completeness check cell confirms all PMIDs stored completely in CSV exports
- Display truncation ("...") is pandas preview artifact only
- Actual data preserved (verified by re-reading CSV files)

**Libraries:** pandas, numpy, plotly, xml.etree.ElementTree, networkx (implicit through PPI analysis)

---

## Key Databases and Resources

**DrugBank XML (`Data/DGIDB/drug_bank.xml`):**
- 22,820 drug-gene interactions
- Includes: drug names, gene targets, actions (inhibitor, antagonist, etc.), molecular functions
- Namespace: `http://www.drugbank.ca`

**STRING PPI Database:**
- Human protein-protein interactions (v12.0)
- Confidence scores: 0-1000 (threshold used: ≥700)
- Files: `9606.protein.links.v12.0.txt`, `9606.protein.info.v12.0.txt`, `9606.protein.aliases.v12.0.txt`

**TCGA HNSC Data:**
- Gene-level CNV: GISTIC scores for ~20,000 genes across ~280 patients
- Somatic mutations: MAF format with ~18,000 genes
- Clinical data: HPV status validated by Nulton et al.

**Literature Validation (PubMed Mining):**
- GPU-accelerated NLP pipeline using Gemma 2B model
- Extracts drug-gene interactions from PubMed articles (post-2000)
- Provides PMIDs for citation traceability
- Files: `cleaned_extracted_targets_all_pub_after_2000_GPU_2b_gemma.csv`

---

## Output Summary

**Final Deliverables:**

1. **Gene Results (Significant Mutations):**
   - `Results/HPV positive gene results.csv`: HPV+ significant genes (CNV + SOM)
   - `Results/HPV negative gene results.csv`: HPV- significant genes (CNV + SOM)

2. **Direct Drug Candidates (Drug → Gene):**
   - `Results/HPV Positive direct results.csv`: All HPV+ direct candidates
   - `Results/HPV Negative direct results.csv`: All HPV- direct candidates
   - `Results/HPV_Positive_Direct_Top50_DrugBank_Verified.csv`: Top 50 HPV+ with DrugBank verification
   - `Results/HPV_Negative_Direct_Top50_DrugBank_Verified.csv`: Top 50 HPV- with DrugBank verification

3. **Indirect Drug Candidates (Drug → Target → Risk Gene via PPI):**
   - `Results/HPV Positive indirect results.csv`: All HPV+ indirect candidates
   - `Results/HPV Negative indirect results.csv`: All HPV- indirect candidates
   - `Results/HPV_Positive_Top50_PPI_Validated.csv`: Top 50 HPV+ with PPI validation
   - `Results/HPV_Negative_Top50_PPI_Validated.csv`: Top 50 HPV- with PPI validation

**Statistical Thresholds:**
- Genetic significance: q_value < 0.05 AND empirical_q_value < 0.05
- Drug enrichment: hypergeom_fdr < 0.05 AND empirical_fdr < 0.05
- PPI confidence: ≥ 700 (STRING database)

**Validation Layers:**
1. Statistical significance (hypergeometric + permutation testing)
2. DrugBank annotation (action mechanisms, molecular functions)
3. Literature validation (PubMed mining with NLP)
4. PPI network validation (STRING database)

---

## Usage Notes

**Execution Order:**
Run notebooks sequentially from 00 to 07 to reproduce the complete pipeline.

**Computational Requirements:**
- Files 02.50 and 03.5: High computational load (100,000 permutation tests)
- File 07: Memory-intensive (large PPI network loading)
- Recommended: ≥16GB RAM, multi-core CPU for parallel processing

**Dependencies:**
- Python 3.8+
- pandas, numpy, scipy, statsmodels
- matplotlib, plotly, networkx
- xml.etree.ElementTree
- tqdm (progress bars)

**Data Updates:**
- DrugBank: Requires updated XML file for latest drug annotations
- STRING: Update PPI database to latest version for current interactions
- TCGA: Data frozen as of analysis date (reflects cohort at time of download)

**Citation:**
When using this pipeline, please cite:
- Nulton et al. (2017) PMC5392278 for HPV status validation
- DrugBank database
- STRING database v12.0
- TCGA HNSC project

---

## Contact and Support

For questions about this pipeline, please refer to the Wu Lab:
   - did@live.unc.edu
   - pvtanike@live.unc.edu

**Key References:**
- Nulton TJ, et al. (2017). Analysis of The Cancer Genome Atlas sequencing data reveals novel properties of the human papillomavirus 16 genome in head and neck squamous cell carcinoma. Oncotarget. 8(11):17684-17699. PMCID: PMC5392278
